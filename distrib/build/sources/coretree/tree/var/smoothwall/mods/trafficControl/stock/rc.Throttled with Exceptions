#! /bin/bash

# Get the NIC definitions
. /var/smoothwall/ethernet/settings
if [ $RED_ADDRESS == "0.0.0.0" ]; then
  RED_ADDRESS=`cat /var/smoothwall/red/local-ipaddress`
fi

export PATH="/sbin:/usr/sbin:/bin:/usr/bin"

# function usage() displays a usage statement and exits 'false'
#
function usage () {
  echo "Usage: $0 stop | start | restart"
  exit 1
}

# function restart calls stop() and start()
#
function restart () {
  stop
  start
}

# function start loads the scheduling modules as needed and enables TC
#
function start () {
  # First be sure the needed modules are loaded
  /sbin/modprobe cls_basic
  /sbin/modprobe cls_flow
  /sbin/modprobe cls_fw
  /sbin/modprobe cls_route
  /sbin/modprobe cls_tcindex
  /sbin/modprobe cls_u32
  /sbin/modprobe sch_cbq
  /sbin/modprobe sch_dsmark
  /sbin/modprobe sch_gred
  /sbin/modprobe sch_hfsc
  /sbin/modprobe sch_htb
  /sbin/modprobe sch_prio
  /sbin/modprobe sch_red
  /sbin/modprobe sch_sfq
  /sbin/modprobe sch_tbf
  /sbin/modprobe sch_teql

  # Clear the iptables TC guck
  iptables -t mangle -D FORWARD -o $RED_DEV -j trafficControl >/dev/null 2>&1
  iptables -t mangle -F trafficControl >/dev/null 2>&1
  iptables -t mangle -X trafficControl >/dev/null 2>&1
  # Prepare the iptables TC guck
  iptables -t mangle -N trafficControl
  iptables -t mangle -A FORWARD -o $RED_DEV -j trafficControl

  # Start of commands for GREEN
  #
  #

  if [ "$GREEN_DEV" != "" ]; then
    # Always silently clear the NIC, configured or not, if it has an IF
    tc qdisc del dev $GREEN_DEV root >/dev/null 2>&1
  fi
    echo "Starting TC on GREEN ($GREEN_DEV)"

  # qdisc: Throttled With Exceptions
  tc qdisc add dev $GREEN_DEV root handle 1:0 htb default 9

  # class: Unthrottled Exceptions
  tc class add dev $GREEN_DEV parent 1:0 classid 1:2 htb prio 1 \
     rate 900000000 burst 30000

  # class: Admin
  tc class add dev $GREEN_DEV parent 1:2 classid 1:3 htb prio 1 \
     rate 180000000 burst 3000 ceil 900000000 cburst 15000

  # class: SSH
  tc class add dev $GREEN_DEV parent 1:3 classid 1:4 htb prio 1 \
     rate 54000000 burst 1500 ceil 900000000 cburst 6000
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 0 u32 \
    match ip sport 222 0xffff \
    match ip src $GREEN_ADDRESS/32 \
    flowid 1:4

  # class: HTTP
  tc class add dev $GREEN_DEV parent 1:3 classid 1:5 htb prio 1 \
     rate 126000000 burst 3000000 ceil 900000000 cburst 15000
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 0 u32 \
    match ip sport 81 0xffff \
    match ip src $GREEN_ADDRESS/32 \
    flowid 1:5
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 441 0xffff \
    match ip src $GREEN_ADDRESS/32 \
    flowid 1:5

  # class: Through Traffic
  tc class add dev $GREEN_DEV parent 1:2 classid 1:6 htb prio 1 \
     rate 720000000 burst 3000 ceil 900000000 cburst 15000

  # class: File Transfer
  tc class add dev $GREEN_DEV parent 1:6 classid 1:a htb prio 1 \
     rate 108000000 burst 16000 ceil 900000000 cburst 1000
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 20 0xfffe \
    flowid 1:a
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 20 0xfffe \
    flowid 1:a
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 9418 0xffff \
    flowid 1:a
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 9418 0xffff \
    flowid 1:a
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 28656 0xffff \
    flowid 1:a

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:a handle c:0 sfq perturb 10 quantum 10000

  # class: DNS
  tc class add dev $GREEN_DEV parent 1:6 classid 1:b htb prio 0 \
     rate 7200000 burst 1500 ceil 9000000 cburst 1500
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 53 0xffff \
    match ip protocol 15 0xff \
    flowid 1:b
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 53 0xffff \
    match ip protocol 15 0xff \
    flowid 1:b

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:b handle b:0 sfq perturb 10 quantum 10000

  # class: Instant Messaging
  tc class add dev $GREEN_DEV parent 1:6 classid 1:c htb prio 2 \
     rate 7200000 burst 1500 ceil 9000000 cburst 1500
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 5190 0xfffe \
    flowid 1:c
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5190 0xfffe \
    flowid 1:c
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 5192 0xfffe \
    flowid 1:c
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5192 0xfffe \
    flowid 1:c
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1863 0xffff \
    flowid 1:c
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1863 0xffff \
    flowid 1:c
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 6880 0xffe0 \
    flowid 1:c
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 6880 0xffe0 \
    flowid 1:c

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:c handle a:0 sfq perturb 10 quantum 10000

  # class: Web Surfing
  tc class add dev $GREEN_DEV parent 1:6 classid 1:d htb prio 1 \
     rate 144000000 burst 125000 ceil 900000000 cburst 250000
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 80 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 80 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 443 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 443 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 800 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 800 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 3128 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 3128 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 8008 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8008 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 8080 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8080 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 441 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 441 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 2083 0xffff \
    flowid 1:d
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 2083 0xffff \
    flowid 1:d

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:d handle 9:0 sfq perturb 10 quantum 10000

  # class: Email
  tc class add dev $GREEN_DEV parent 1:6 classid 1:e htb prio 1 \
     rate 144000000 burst 250000 ceil 900000000 cburst 1000000
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 25 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 25 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 110 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 110 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 443 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 443 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 993 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 993 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 995 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 995 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 587 0xffff \
    flowid 1:e
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 587 0xffff \
    flowid 1:e

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:e handle 8:0 sfq perturb 10 quantum 10000

  # class: SSH
  tc class add dev $GREEN_DEV parent 1:6 classid 1:f htb prio 1 \
     rate 144000000 burst 1500 ceil 900000000 cburst 8000
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 22 0xffff \
    flowid 1:f
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 22 0xffff \
    flowid 1:f
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 8627 0xffff \
    flowid 1:f
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8627 0xffff \
    flowid 1:f

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:f handle 7:0 sfq perturb 10 quantum 10000

  # class: VoIP
  tc class add dev $GREEN_DEV parent 1:6 classid 1:10 htb prio 0 \
     rate 720000 burst 1500 ceil 2700000 cburst 4500
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1503 0xffff \
    flowid 1:10
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1503 0xffff \
    flowid 1:10
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1720 0xffff \
    flowid 1:10
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1720 0xffff \
    flowid 1:10
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 3782 0xffff \
    flowid 1:10
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 3782 0xffff \
    flowid 1:10
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 5056 0xfff0 \
    flowid 1:10
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5056 0xfff0 \
    flowid 1:10

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:10 handle 6:0 sfq perturb 10 quantum 1500

  # class: VPN
  tc class add dev $GREEN_DEV parent 1:6 classid 1:12 htb prio 1 \
     rate 144000000 burst 9000 ceil 900000000 cburst 18000

  # class: PPTP
  tc class add dev $GREEN_DEV parent 1:12 classid 1:13 htb prio 1 \
     rate 47520000 burst 3000 ceil 900000000 cburst 6000
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1732 0xffff \
    flowid 1:13
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 47 0xff \
    flowid 1:13

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:13 handle d:0 sfq perturb 10 quantum 10000

  # class: IPSEC
  tc class add dev $GREEN_DEV parent 1:12 classid 1:14 htb prio 1 \
     rate 47520000 burst 3000 ceil 900000000 cburst 6000
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 50 0xff \
    flowid 1:14
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 51 0xff \
    flowid 1:14
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 500 0xffff \
    flowid 1:14
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 4500 0xffff \
    flowid 1:14
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 4500 0xffff \
    flowid 1:14
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 500 0xffff \
    flowid 1:14

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:14 handle e:0 sfq perturb 10 quantum 10000

  # class: OpenVPN
  tc class add dev $GREEN_DEV parent 1:12 classid 1:15 htb prio 1 \
     rate 47520000 burst 3000 ceil 900000000 cburst 6000
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1194 0xffff \
    flowid 1:15
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1194 0xffff \
    flowid 1:15
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1195 0xffff \
    flowid 1:15
  tc filter add dev $GREEN_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1195 0xffff \
    flowid 1:15

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:15 handle f:0 sfq perturb 10 quantum 10000

  # class: Throttled Traffic
  tc class add dev $GREEN_DEV parent 1:0 classid 1:9 htb prio 7 \
     rate 56000 burst 1500

  # qdisc: Fair
  tc qdisc add dev $GREEN_DEV parent 1:9 handle 4:0 sfq perturb 10 quantum 10000

  #
  #
  # End of commands for GREEN

  # Start of commands for PURPLE
  #
  #

  if [ "$PURPLE_DEV" != "" ]; then
    # Always silently clear the NIC, configured or not, if it has an IF
    tc qdisc del dev $PURPLE_DEV root >/dev/null 2>&1
  fi
    echo "Starting TC on PURPLE ($PURPLE_DEV)"

  # qdisc: Throttled With Exceptions
  tc qdisc add dev $PURPLE_DEV root handle 1:0 htb default 9

  # class: Unthrottled Exceptions
  tc class add dev $PURPLE_DEV parent 1:0 classid 1:2 htb prio 1 \
     rate 28000000 burst 30000

  # class: Admin
  tc class add dev $PURPLE_DEV parent 1:2 classid 1:3 htb prio 1 \
     rate 5600000 burst 3000 ceil 28000000 cburst 15000

  # class: SSH
  tc class add dev $PURPLE_DEV parent 1:3 classid 1:4 htb prio 1 \
     rate 1680000 burst 1500 ceil 28000000 cburst 6000
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 0 u32 \
    match ip sport 222 0xffff \
    match ip src $PURPLE_ADDRESS/32 \
    flowid 1:4

  # class: HTTP
  tc class add dev $PURPLE_DEV parent 1:3 classid 1:5 htb prio 1 \
     rate 3920000 burst 3000000 ceil 28000000 cburst 15000
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 0 u32 \
    match ip sport 81 0xffff \
    match ip src $PURPLE_ADDRESS/32 \
    flowid 1:5
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 441 0xffff \
    match ip src $PURPLE_ADDRESS/32 \
    flowid 1:5

  # class: Through Traffic
  tc class add dev $PURPLE_DEV parent 1:2 classid 1:6 htb prio 1 \
     rate 22400000 burst 3000 ceil 28000000 cburst 15000

  # class: File Transfer
  tc class add dev $PURPLE_DEV parent 1:6 classid 1:a htb prio 1 \
     rate 3360000 burst 16000 ceil 28000000 cburst 1000
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 20 0xfffe \
    flowid 1:a
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 20 0xfffe \
    flowid 1:a
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 9418 0xffff \
    flowid 1:a
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 9418 0xffff \
    flowid 1:a

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:a handle c:0 sfq perturb 10 quantum 10000

  # class: DNS
  tc class add dev $PURPLE_DEV parent 1:6 classid 1:b htb prio 0 \
     rate 224000 burst 1500 ceil 280000 cburst 1500
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 53 0xffff \
    match ip protocol 15 0xff \
    flowid 1:b
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 53 0xffff \
    match ip protocol 15 0xff \
    flowid 1:b

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:b handle b:0 sfq perturb 10 quantum 10000

  # class: Instant Messaging
  tc class add dev $PURPLE_DEV parent 1:6 classid 1:c htb prio 2 \
     rate 224000 burst 1500 ceil 280000 cburst 1500
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 5190 0xfffe \
    flowid 1:c
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5190 0xfffe \
    flowid 1:c
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 5192 0xfffe \
    flowid 1:c
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5192 0xfffe \
    flowid 1:c
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1863 0xffff \
    flowid 1:c
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1863 0xffff \
    flowid 1:c
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 6880 0xffe0 \
    flowid 1:c
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 6880 0xffe0 \
    flowid 1:c

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:c handle a:0 sfq perturb 10 quantum 10000

  # class: Web Surfing
  tc class add dev $PURPLE_DEV parent 1:6 classid 1:d htb prio 1 \
     rate 4480000 burst 125000 ceil 28000000 cburst 250000
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 80 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 80 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 443 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 443 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 800 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 800 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 3128 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 3128 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 8008 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8008 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 8080 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8080 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 441 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 441 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 2083 0xffff \
    flowid 1:d
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 2083 0xffff \
    flowid 1:d

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:d handle 9:0 sfq perturb 10 quantum 10000

  # class: Email
  tc class add dev $PURPLE_DEV parent 1:6 classid 1:e htb prio 1 \
     rate 4480000 burst 250000 ceil 28000000 cburst 1000000
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 25 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 25 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 110 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 110 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 443 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 443 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 993 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 993 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 995 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 995 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 587 0xffff \
    flowid 1:e
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 587 0xffff \
    flowid 1:e

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:e handle 8:0 sfq perturb 10 quantum 10000

  # class: SSH
  tc class add dev $PURPLE_DEV parent 1:6 classid 1:f htb prio 1 \
     rate 4480000 burst 1500 ceil 28000000 cburst 8000
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 22 0xffff \
    flowid 1:f
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 22 0xffff \
    flowid 1:f
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 8627 0xffff \
    flowid 1:f
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8627 0xffff \
    flowid 1:f

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:f handle 7:0 sfq perturb 10 quantum 10000

  # class: VoIP
  tc class add dev $PURPLE_DEV parent 1:6 classid 1:10 htb prio 0 \
     rate 22400 burst 1500 ceil 84000 cburst 4500
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1503 0xffff \
    flowid 1:10
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1503 0xffff \
    flowid 1:10
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1720 0xffff \
    flowid 1:10
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1720 0xffff \
    flowid 1:10
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 3782 0xffff \
    flowid 1:10
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 3782 0xffff \
    flowid 1:10
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 5056 0xfff0 \
    flowid 1:10
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5056 0xfff0 \
    flowid 1:10

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:10 handle 6:0 sfq perturb 10 quantum 1500

  # class: VPN
  tc class add dev $PURPLE_DEV parent 1:6 classid 1:12 htb prio 1 \
     rate 4480000 burst 9000 ceil 28000000 cburst 18000

  # class: PPTP
  tc class add dev $PURPLE_DEV parent 1:12 classid 1:13 htb prio 1 \
     rate 1478400 burst 3000 ceil 28000000 cburst 6000
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1732 0xffff \
    flowid 1:13
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 47 0xff \
    flowid 1:13

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:13 handle d:0 sfq perturb 10 quantum 10000

  # class: IPSEC
  tc class add dev $PURPLE_DEV parent 1:12 classid 1:14 htb prio 1 \
     rate 1478400 burst 3000 ceil 28000000 cburst 6000
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 50 0xff \
    flowid 1:14
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 51 0xff \
    flowid 1:14
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 500 0xffff \
    flowid 1:14
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 4500 0xffff \
    flowid 1:14
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 4500 0xffff \
    flowid 1:14
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 500 0xffff \
    flowid 1:14

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:14 handle e:0 sfq perturb 10 quantum 10000

  # class: OpenVPN
  tc class add dev $PURPLE_DEV parent 1:12 classid 1:15 htb prio 1 \
     rate 1478400 burst 3000 ceil 28000000 cburst 6000
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1194 0xffff \
    flowid 1:15
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1194 0xffff \
    flowid 1:15
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1195 0xffff \
    flowid 1:15
  tc filter add dev $PURPLE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1195 0xffff \
    flowid 1:15

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:15 handle f:0 sfq perturb 10 quantum 10000

  # class: Throttled Traffic
  tc class add dev $PURPLE_DEV parent 1:0 classid 1:9 htb prio 7 \
     rate 56000 burst 1500

  # qdisc: Fair
  tc qdisc add dev $PURPLE_DEV parent 1:9 handle 4:0 sfq perturb 10 quantum 10000

  #
  #
  # End of commands for PURPLE

  # Start of commands for ORANGE
  #
  #

  if [ "$ORANGE_DEV" != "" ]; then
    # Always silently clear the NIC, configured or not, if it has an IF
    tc qdisc del dev $ORANGE_DEV root >/dev/null 2>&1
  fi
    echo "Starting TC on ORANGE ($ORANGE_DEV)"

  # qdisc: Throttled With Exceptions
  tc qdisc add dev $ORANGE_DEV root handle 1:0 htb default 9

  # class: Unthrottled Exceptions
  tc class add dev $ORANGE_DEV parent 1:0 classid 1:2 htb prio 1 \
     rate 91000000 burst 30000

  # class: Admin
  tc class add dev $ORANGE_DEV parent 1:2 classid 1:3 htb prio 1 \
     rate 18200000 burst 3000 ceil 91000000 cburst 15000

  # class: SSH
  tc class add dev $ORANGE_DEV parent 1:3 classid 1:4 htb prio 1 \
     rate 5460000 burst 1500 ceil 91000000 cburst 6000
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 0 u32 \
    match ip sport 222 0xffff \
    match ip src $ORANGE_ADDRESS/32 \
    flowid 1:4

  # class: HTTP
  tc class add dev $ORANGE_DEV parent 1:3 classid 1:5 htb prio 1 \
     rate 12740000 burst 3000000 ceil 91000000 cburst 15000
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 0 u32 \
    match ip sport 81 0xffff \
    match ip src $ORANGE_ADDRESS/32 \
    flowid 1:5
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 441 0xffff \
    match ip src $ORANGE_ADDRESS/32 \
    flowid 1:5

  # class: Through Traffic
  tc class add dev $ORANGE_DEV parent 1:2 classid 1:6 htb prio 1 \
     rate 72800000 burst 3000 ceil 91000000 cburst 15000

  # class: File Transfer
  tc class add dev $ORANGE_DEV parent 1:6 classid 1:a htb prio 1 \
     rate 10920000 burst 16000 ceil 91000000 cburst 1000
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 20 0xfffe \
    flowid 1:a
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 20 0xfffe \
    flowid 1:a
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 9418 0xffff \
    flowid 1:a
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 9418 0xffff \
    flowid 1:a

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:a handle c:0 sfq perturb 10 quantum 10000

  # class: DNS
  tc class add dev $ORANGE_DEV parent 1:6 classid 1:b htb prio 0 \
     rate 728000 burst 1500 ceil 910000 cburst 1500
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 53 0xffff \
    match ip protocol 15 0xff \
    flowid 1:b
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 53 0xffff \
    match ip protocol 15 0xff \
    flowid 1:b

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:b handle b:0 sfq perturb 10 quantum 10000

  # class: Instant Messaging
  tc class add dev $ORANGE_DEV parent 1:6 classid 1:c htb prio 2 \
     rate 728000 burst 1500 ceil 910000 cburst 1500
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 5190 0xfffe \
    flowid 1:c
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5190 0xfffe \
    flowid 1:c
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 5192 0xfffe \
    flowid 1:c
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5192 0xfffe \
    flowid 1:c
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1863 0xffff \
    flowid 1:c
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1863 0xffff \
    flowid 1:c
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 6880 0xffe0 \
    flowid 1:c
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 6880 0xffe0 \
    flowid 1:c

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:c handle a:0 sfq perturb 10 quantum 10000

  # class: Web Surfing
  tc class add dev $ORANGE_DEV parent 1:6 classid 1:d htb prio 1 \
     rate 14560000 burst 125000 ceil 91000000 cburst 250000
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 80 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 80 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 443 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 443 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 800 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 800 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 3128 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 3128 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 8008 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8008 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 8080 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8080 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 441 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 441 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 2083 0xffff \
    flowid 1:d
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 2083 0xffff \
    flowid 1:d

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:d handle 9:0 sfq perturb 10 quantum 10000

  # class: Email
  tc class add dev $ORANGE_DEV parent 1:6 classid 1:e htb prio 1 \
     rate 14560000 burst 250000 ceil 91000000 cburst 1000000
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 25 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 25 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 110 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 110 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 443 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 443 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 993 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 993 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 995 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 995 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 587 0xffff \
    flowid 1:e
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 587 0xffff \
    flowid 1:e

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:e handle 8:0 sfq perturb 10 quantum 10000

  # class: SSH
  tc class add dev $ORANGE_DEV parent 1:6 classid 1:f htb prio 1 \
     rate 14560000 burst 1500 ceil 91000000 cburst 8000
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 22 0xffff \
    flowid 1:f
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 22 0xffff \
    flowid 1:f
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 8627 0xffff \
    flowid 1:f
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8627 0xffff \
    flowid 1:f

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:f handle 7:0 sfq perturb 10 quantum 10000

  # class: VoIP
  tc class add dev $ORANGE_DEV parent 1:6 classid 1:10 htb prio 0 \
     rate 72800 burst 1500 ceil 273000 cburst 4500
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1503 0xffff \
    flowid 1:10
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1503 0xffff \
    flowid 1:10
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1720 0xffff \
    flowid 1:10
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1720 0xffff \
    flowid 1:10
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 3782 0xffff \
    flowid 1:10
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 3782 0xffff \
    flowid 1:10
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 5056 0xfff0 \
    flowid 1:10
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5056 0xfff0 \
    flowid 1:10

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:10 handle 6:0 sfq perturb 10 quantum 1500

  # class: VPN
  tc class add dev $ORANGE_DEV parent 1:6 classid 1:12 htb prio 1 \
     rate 14560000 burst 9000 ceil 91000000 cburst 18000

  # class: PPTP
  tc class add dev $ORANGE_DEV parent 1:12 classid 1:13 htb prio 1 \
     rate 4804800 burst 3000 ceil 91000000 cburst 6000
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1732 0xffff \
    flowid 1:13
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 47 0xff \
    flowid 1:13

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:13 handle d:0 sfq perturb 10 quantum 10000

  # class: IPSEC
  tc class add dev $ORANGE_DEV parent 1:12 classid 1:14 htb prio 1 \
     rate 4804800 burst 3000 ceil 91000000 cburst 6000
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 50 0xff \
    flowid 1:14
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 51 0xff \
    flowid 1:14
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 500 0xffff \
    flowid 1:14
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 4500 0xffff \
    flowid 1:14
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 4500 0xffff \
    flowid 1:14
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 500 0xffff \
    flowid 1:14

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:14 handle e:0 sfq perturb 10 quantum 10000

  # class: OpenVPN
  tc class add dev $ORANGE_DEV parent 1:12 classid 1:15 htb prio 1 \
     rate 4804800 burst 3000 ceil 91000000 cburst 6000
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1194 0xffff \
    flowid 1:15
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1194 0xffff \
    flowid 1:15
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 1195 0xffff \
    flowid 1:15
  tc filter add dev $ORANGE_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1195 0xffff \
    flowid 1:15

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:15 handle f:0 sfq perturb 10 quantum 10000

  # class: Throttled Traffic
  tc class add dev $ORANGE_DEV parent 1:0 classid 1:9 htb prio 7 \
     rate 56000 burst 1500

  # qdisc: Fair
  tc qdisc add dev $ORANGE_DEV parent 1:9 handle 4:0 sfq perturb 10 quantum 10000

  #
  #
  # End of commands for ORANGE

  # Start of commands for RED
  #
  #

  if [ "$RED_DEV" != "" ]; then
    # Always silently clear the NIC, configured or not, if it has an IF
    tc qdisc del dev $RED_DEV root >/dev/null 2>&1
  fi
    echo "Starting TC on RED ($RED_DEV)"

  # qdisc: Throttled With Exceptions
  tc qdisc add dev $RED_DEV root handle 1:0 htb default 9

  # class: Unthrottled Exceptions
  tc class add dev $RED_DEV parent 1:0 classid 1:2 htb prio 1 \
     rate 3000000 burst 30000

  # class: Admin
  tc class add dev $RED_DEV parent 1:2 classid 1:3 htb prio 1 \
     rate 600000 burst 3000 ceil 3000000 cburst 15000

  # class: SSH
  tc class add dev $RED_DEV parent 1:3 classid 1:4 htb prio 1 \
     rate 180000 burst 1500 ceil 3000000 cburst 6000
  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 0 u32 \
    match ip sport 222 0xffff \
    match ip src $RED_ADDRESS/32 \
    flowid 1:4

  # class: HTTP
  tc class add dev $RED_DEV parent 1:3 classid 1:5 htb prio 1 \
     rate 420000 burst 3000000 ceil 3000000 cburst 15000
  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 0 u32 \
    match ip sport 81 0xffff \
    match ip src $RED_ADDRESS/32 \
    flowid 1:5
  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip sport 441 0xffff \
    match ip src $RED_ADDRESS/32 \
    flowid 1:5

  # class: Through Traffic
  tc class add dev $RED_DEV parent 1:2 classid 1:6 htb prio 1 \
     rate 2400000 burst 3000 ceil 3000000 cburst 15000

  # class: File Transfer
  tc class add dev $RED_DEV parent 1:6 classid 1:a htb prio 1 \
     rate 360000 burst 16000 ceil 3000000 cburst 1000
  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 20 0xfffe \
    flowid 1:a
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 20 \
    -j CLASSIFY --set-class 1:a

  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 9418 \
    -j CLASSIFY --set-class 1:a

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 9418 0xffff \
    flowid 1:a

  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:a handle c:0 sfq perturb 10 quantum 10000

  # class: DNS
  tc class add dev $RED_DEV parent 1:6 classid 1:b htb prio 0 \
     rate 24000 burst 1500 ceil 30000 cburst 1500
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 15/ff \
    --sport 53 \
    -j CLASSIFY --set-class 1:b

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 53 0xffff \
    match ip protocol 15 0xff \
    flowid 1:b

  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:b handle b:0 sfq perturb 10 quantum 10000

  # class: Instant Messaging
  tc class add dev $RED_DEV parent 1:6 classid 1:c htb prio 2 \
     rate 24000 burst 1500 ceil 30000 cburst 1500
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 5190 \
    -j CLASSIFY --set-class 1:c

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5190 0xfffe \
    flowid 1:c
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 5192 \
    -j CLASSIFY --set-class 1:c

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5192 0xfffe \
    flowid 1:c
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 1863 \
    -j CLASSIFY --set-class 1:c

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1863 0xffff \
    flowid 1:c
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 6880 \
    -j CLASSIFY --set-class 1:c

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 6880 0xffe0 \
    flowid 1:c

  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:c handle a:0 sfq perturb 10 quantum 10000

  # class: Web Surfing
  tc class add dev $RED_DEV parent 1:6 classid 1:d htb prio 1 \
     rate 480000 burst 125000 ceil 3000000 cburst 250000
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 80 \
    -j CLASSIFY --set-class 1:d

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 80 0xffff \
    flowid 1:d
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 443 \
    -j CLASSIFY --set-class 1:d

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 443 0xffff \
    flowid 1:d
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 800 \
    -j CLASSIFY --set-class 1:d

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 800 0xffff \
    flowid 1:d
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 3128 \
    -j CLASSIFY --set-class 1:d

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 3128 0xffff \
    flowid 1:d
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 8008 \
    -j CLASSIFY --set-class 1:d

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8008 0xffff \
    flowid 1:d
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 8080 \
    -j CLASSIFY --set-class 1:d

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8080 0xffff \
    flowid 1:d
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 441 \
    -j CLASSIFY --set-class 1:d

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 441 0xffff \
    flowid 1:d
  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 2083 0xffff \
    flowid 1:d
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 2083 \
    -j CLASSIFY --set-class 1:d


  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:d handle 9:0 sfq perturb 10 quantum 10000

  # class: Email
  tc class add dev $RED_DEV parent 1:6 classid 1:e htb prio 1 \
     rate 480000 burst 250000 ceil 3000000 cburst 1000000
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 25 \
    -j CLASSIFY --set-class 1:e

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 25 0xffff \
    flowid 1:e
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 110 \
    -j CLASSIFY --set-class 1:e

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 110 0xffff \
    flowid 1:e
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 443 \
    -j CLASSIFY --set-class 1:e

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 443 0xffff \
    flowid 1:e
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 993 \
    -j CLASSIFY --set-class 1:e

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 993 0xffff \
    flowid 1:e
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 995 \
    -j CLASSIFY --set-class 1:e

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 995 0xffff \
    flowid 1:e
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 587 \
    -j CLASSIFY --set-class 1:e

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 587 0xffff \
    flowid 1:e

  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:e handle 8:0 sfq perturb 10 quantum 10000

  # class: SSH
  tc class add dev $RED_DEV parent 1:6 classid 1:f htb prio 1 \
     rate 480000 burst 1500 ceil 3000000 cburst 8000
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 22 \
    -j CLASSIFY --set-class 1:f

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 22 0xffff \
    flowid 1:f
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 8627 \
    -j CLASSIFY --set-class 1:f

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 8627 0xffff \
    flowid 1:f

  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:f handle 7:0 sfq perturb 10 quantum 10000

  # class: VoIP
  tc class add dev $RED_DEV parent 1:6 classid 1:10 htb prio 0 \
     rate 2400 burst 1500 ceil 9000 cburst 4500
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 1503 \
    -j CLASSIFY --set-class 1:10

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1503 0xffff \
    flowid 1:10
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 1720 \
    -j CLASSIFY --set-class 1:10

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1720 0xffff \
    flowid 1:10
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 3782 \
    -j CLASSIFY --set-class 1:10

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 3782 0xffff \
    flowid 1:10
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 5056 \
    -j CLASSIFY --set-class 1:10

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 5056 0xfff0 \
    flowid 1:10

  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:10 handle 6:0 sfq perturb 10 quantum 1500

  # class: VPN
  tc class add dev $RED_DEV parent 1:6 classid 1:12 htb prio 1 \
     rate 480000 burst 9000 ceil 3000000 cburst 18000

  # class: PPTP
  tc class add dev $RED_DEV parent 1:12 classid 1:13 htb prio 1 \
     rate 158400 burst 3000 ceil 3000000 cburst 6000
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 1732 \
    -j CLASSIFY --set-class 1:13

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 47 0xff \
    flowid 1:13

  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:13 handle d:0 sfq perturb 10 quantum 10000

  # class: IPSEC
  tc class add dev $RED_DEV parent 1:12 classid 1:14 htb prio 1 \
     rate 158400 burst 3000 ceil 3000000 cburst 6000
  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 50 0xff \
    flowid 1:14
  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip protocol 51 0xff \
    flowid 1:14
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 500 \
    -j CLASSIFY --set-class 1:14

  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 4500 \
    -j CLASSIFY --set-class 1:14

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 4500 0xffff \
    flowid 1:14
  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 500 0xffff \
    flowid 1:14

  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:14 handle e:0 sfq perturb 10 quantum 10000

  # class: OpenVPN
  tc class add dev $RED_DEV parent 1:12 classid 1:15 htb prio 1 \
     rate 158400 burst 3000 ceil 3000000 cburst 6000
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 1194 \
    -j CLASSIFY --set-class 1:15

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1194 0xffff \
    flowid 1:15
  iptables -t mangle -A trafficControl -o $RED_DEV --protocol 6 \
    --sport 1195 \
    -j CLASSIFY --set-class 1:15

  tc filter add dev $RED_DEV protocol ip parent 1:0 prio 1 u32 \
    match ip dport 1195 0xffff \
    flowid 1:15

  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:15 handle f:0 sfq perturb 10 quantum 10000

  # class: Throttled Traffic
  tc class add dev $RED_DEV parent 1:0 classid 1:9 htb prio 7 \
     rate 56000 burst 1500

  # qdisc: Fair
  tc qdisc add dev $RED_DEV parent 1:9 handle 4:0 sfq perturb 10 quantum 10000

  #
  #
  # End of commands for RED

}

# function stop disables TC; the system restores the default qdisc
#
function stop () {
  # Clear the iptables TC guck
  iptables -t mangle -D FORWARD -o $RED_DEV -j trafficControl >/dev/null 2>&1
  iptables -t mangle -F trafficControl >/dev/null 2>&1
  iptables -t mangle -X trafficControl >/dev/null 2>&1

  if [ "$GREEN_DEV" != "" ]; then
    echo "Stopping TC on GREEN ($GREEN_DEV)"
    tc qdisc del dev $GREEN_DEV root >/dev/null 2>&1
  fi

  if [ "$PURPLE_DEV" != "" ]; then
    echo "Stopping TC on PURPLE ($PURPLE_DEV)"
    tc qdisc del dev $PURPLE_DEV root >/dev/null 2>&1
  fi

  if [ "$ORANGE_DEV" != "" ]; then
    echo "Stopping TC on ORANGE ($ORANGE_DEV)"
    tc qdisc del dev $ORANGE_DEV root >/dev/null 2>&1
  fi

  if [ "$RED_DEV" != "" ]; then
    echo "Stopping TC on RED ($RED_DEV)"
    tc qdisc del dev $RED_DEV root >/dev/null 2>&1
  fi
}

# The main actions
#
case $1 in
  stop) stop; ;;
  start) start; ;;
  restart) restart; ;;
  *) usage; ;;
esac

exit

